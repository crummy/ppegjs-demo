const ct=[["rule",[["id","Peg"],["seq",[["id","_"],["rep",[["id","rule"],["sfx","+"]]],["id","_"]]]]],["rule",[["id","rule"],["seq",[["id","id"],["id","_"],["sq","'='"],["id","_"],["id","alt"]]]]],["rule",[["id","alt"],["seq",[["id","seq"],["rep",[["seq",[["sq","'/'"],["id","_"],["id","seq"]]],["sfx","*"]]]]]]],["rule",[["id","seq"],["rep",[["id","rep"],["sfx","+"]]]]],["rule",[["id","rep"],["seq",[["id","pre"],["rep",[["id","sfx"],["sfx","?"]]],["id","_"]]]]],["rule",[["id","pre"],["seq",[["rep",[["id","pfx"],["sfx","?"]]],["id","term"]]]]],["rule",[["id","term"],["alt",[["id","call"],["id","sq"],["id","chs"],["id","group"],["id","extn"]]]]],["rule",[["id","id"],["seq",[["chs","[a-zA-Z_]"],["rep",[["chs","[a-zA-Z0-9_]"],["sfx","*"]]]]]]],["rule",[["id","pfx"],["chs","[&!~]"]]],["rule",[["id","sfx"],["alt",[["chs","[+?]"],["seq",[["sq","'*'"],["rep",[["id","range"],["sfx","?"]]]]]]]]],["rule",[["id","range"],["seq",[["id","num"],["rep",[["seq",[["id","dots"],["rep",[["id","num"],["sfx","?"]]]]],["sfx","?"]]]]]]],["rule",[["id","num"],["rep",[["chs","[0-9]"],["sfx","+"]]]]],["rule",[["id","dots"],["sq","'..'"]]],["rule",[["id","call"],["seq",[["id","id"],["id","_"],["pre",[["pfx","!"],["sq","'='"]]]]]]],["rule",[["id","sq"],["seq",[["chs","[']"],["rep",[["pre",[["pfx","~"],["chs","[']"]]],["sfx","*"]]],["chs","[']"],["rep",[["sq","'i'"],["sfx","?"]]]]]]],["rule",[["id","chs"],["seq",[["sq","'['"],["rep",[["pre",[["pfx","~"],["sq","']'"]]],["sfx","*"]]],["sq","']'"]]]]],["rule",[["id","group"],["seq",[["sq","'('"],["id","_"],["id","alt"],["sq","')'"]]]]],["rule",[["id","extn"],["seq",[["sq","'<'"],["rep",[["pre",[["pfx","~"],["sq","'>'"]]],["sfx","*"]]],["sq","'>'"]]]]],["rule",[["id","_"],["rep",[["alt",[["seq",[["sq","'#'"],["rep",[["pre",[["pfx","~"],["chs",`[
\r]`]]],["sfx","*"]]]]],["rep",[["chs",`[ 	
\r]`],["sfx","*"]]]]],["sfx","*"]]]]]],lt=tt(ct);function L(e,t){const[,r,s]=e,a=t.pos,n=t.tree.length,o=t.metadata_tree.length,l=t.code[r];if(t.panic||t.depth>t.max_depth){t.panic||(t.panic=`max depth of recursion exceeded in rules:
 ... ${t.rule_names.slice(-6).join(" ")}
`);const c={rule:s,rule_id:r,start:a,end:t.pos,id:t.last_match_id++,children:[],error:{type:"max_depth_exceeded",message:`Maximum recursion depth exceeded in rule: ${s}`}};return t.metadata_tree.push(c),!1}t.trace&&bt(s,t),t.depth+=1,t.rule_names[t.depth]=s,t.start[t.depth]=a,t.stack[t.depth]=n,t.metadata_stack[t.depth]=o;const u=l[0](l,t);if(t.depth-=1,u===!1){if(t.trace&&S(e,t,!1),t.metadata_tree.length===o){const c={rule:s,rule_id:r,start:a,end:t.pos,id:t.last_match_id++,children:[],error:{type:"rule_match_failed",message:`Failed to match rule: ${s}`}};t.metadata_tree.push(c)}return t.pos=a,t.tree.length=n,t.metadata_tree.length=o,!1}if(s[0]==="_")return t.tree.length>n&&(t.tree=t.tree.slice(0,n),t.metadata_tree=t.metadata_tree.slice(0,o)),t.trace&&S(e,t,!0,a),!0;const i={rule:s,rule_id:r,start:a,end:t.pos,id:t.last_match_id++,children:[]};if(t.tree.length-n>1||s[0]<="Z"){const c=[s,t.tree.slice(n)];return i.children=t.metadata_tree.slice(o),t.tree=t.tree.slice(0,n),t.metadata_tree=t.metadata_tree.slice(0,o),t.tree.push(c),t.metadata_tree.push(i),t.trace&&S(e,t,c),!0}if(t.tree.length===n){const c=t.input.slice(a,t.pos),d=[s,c];return i.match=c,t.tree.push(d),t.metadata_tree.push(i),t.trace&&S(e,t,d),!0}return t.trace&&S(e,t,t.tree[t.tree.length-1]),!0}function H(e,t){t.trace&&U(e,t);const r=t.pos,s=t.tree.length,a=t.metadata_tree.length,n=t.input[r];for(let o=0;o<e[1].length;o+=1){if(!t.trace&&e.length>2){const i=e[2][o];if(i&&n!==i)continue}const l=e[1][o];if(l[0](l,t))return!0;t.tree.length>s&&(t.tree=t.tree.slice(0,s)),t.metadata_tree.length>a&&(t.metadata_tree=t.metadata_tree.slice(0,a)),t.pos=r}return!1}function E(e,t){t.trace&&U(e,t);const[r,s,a,n]=e;let o=0;for(;;){let l=0,u=t.pos;const i=t.tree.length,c=t.metadata_tree.length;for(l=0;l<n.length;l+=1){const d=n[l];if(d[0](d,t)===!1){if(o>=s)return t.pos=u,t.tree.length>i&&(t.tree=t.tree.slice(0,i)),t.metadata_tree.length>c&&(t.metadata_tree=t.metadata_tree.slice(0,c)),!0;if(t.pos>u){const p={rule:t.rule_names[t.depth]||"sequence",start:u,end:t.pos,id:t.last_match_id++,children:t.metadata_tree.slice(c),error:{type:"sequence_element_failed",message:`Failed to match element ${l} in sequence rule: ${t.rule_names[t.depth]}`}};(t.metadata_tree.length===c||!t.metadata_tree[t.metadata_tree.length-1].error)&&t.metadata_tree.push(p)}return!1}}if(o+=1,o===a||t.pos===u)break;u=t.pos}return o>=s}function X(e,t){t.trace&&U(e,t);const[r,s,a,n]=e,o=t.tree.length,l=t.metadata_tree.length;let u=0,i=t.pos;for(;!(n[0](n,t)===!1||(u+=1,i===t.pos)||u===a);)i=t.pos;if(u<s){const c={rule:t.rule_names[t.depth]||"repetition",start:i,end:t.pos,id:t.last_match_id++,children:t.metadata_tree.slice(l),error:{type:"repetition_min_not_met",message:`Expected at least ${s} repetitions, but got ${u}`}};return(t.metadata_tree.length===l||!t.metadata_tree[t.metadata_tree.length-1].error)&&t.metadata_tree.push(c),t.tree.length>o&&(t.tree=t.tree.slice(0,o)),t.metadata_tree.length>l&&(t.metadata_tree=t.metadata_tree.slice(0,l)),!1}return!0}function B(e,t){const[r,s,a]=e,n=t.pos,o=t.tree.length,l=t.metadata_tree.length,u=t.trace,i=t.peak;t.trace=!1;const c=a[0](a,t);return t.peak=i,t.trace=u,u&&Et(e,t,c),t.tree.length>o&&(t.tree=t.tree.slice(0,o)),t.metadata_tree.length>l&&(t.metadata_tree=t.metadata_tree.slice(0,l)),t.pos=n,s==="~"?c===!0||t.pos>=t.input.length?!1:(t.pos=n+1,t.peak<t.pos&&(t.peak=t.pos),!0):s==="!"?!c:c}function M(e,t){const r=t.pos,s=t.input,[a,n,o]=e,l=o.length;if(l===0)return!0;let u=t.pos;for(let i=0;i<l;i+=1){let c=s[u];if(n&&u<s.length&&(c=c.toUpperCase()),o[i]!==c){t.pos=r;const d={rule:"string_literal",start:r,end:u,id:t.last_match_id++,children:[],error:{type:"string_literal_mismatch",message:`Expected '${o}' at position ${r}, found '${s.slice(r,r+10)}...'`}};return t.metadata_tree.push(d),t.trace&&Y(e,t),!1}u+=1}return t.pos=u,u>t.peak&&(t.peak=u),t.trace&&K(e,t,r),!0}function k(e,t){const r=t.input,s=t.pos,[a,n,o,l,u]=e;let i=t.pos,c=0;for(;i<r.length;){let d=!1;const f=t.input[i];for(let p=0;p<u.length;p+=1){if(p+2<u.length&&u[p+1]==="-"){if(f<u[p]||f>u[p+2]){p+=2;continue}}else if(f!==u[p])continue;d=!0;break}if(n&&(d=!d),!d||(c+=1,i+=1,c===l))break}if(c<o){const d=n?`not in [${u}]`:`in [${u}]`,f=i<r.length?r[i]:"EOF",p={rule:"character_class",start:s,end:i,id:t.last_match_id++,children:[],error:{type:"character_class_mismatch",message:`Expected character ${d} at position ${s}, found '${f}'`}};return t.metadata_tree.push(p),t.trace&&Y(e,t),!1}return t.pos=i,i>t.peak&&(t.peak=i),t.trace&&K(e,t,s),!0}function D(e,t){const s=e[1].slice(1,-1).split(" ")[0],a=t.extend[s]||dt(s);if(!a){const n={rule:"extension",start:t.pos,end:t.pos,id:t.last_match_id++,children:[],error:{type:"missing_extension",message:`Missing extension function: ${s}`}};return t.metadata_tree.push(n),!1}try{const n=a(e,t);if(t.trace&&yt(e,t,n),n)return!0;const o={rule:"extension",start:t.pos,end:t.pos,id:t.last_match_id++,children:[],error:{type:"extension_failed",message:`Extension function ${s} failed to match`}};return t.metadata_tree.push(o),!1}catch(n){t.panic=n;const o={rule:"extension",start:t.pos,end:t.pos,id:t.last_match_id++,children:[],error:{type:"extension_exception",message:`Extension function ${s} threw an exception: ${n}`}};return t.metadata_tree.push(o),!1}}const ut={"?":ft,trace:qt,"@":j,eq:j,at:j,infix:pt,quote:ht,quoter:_t,indent:mt,inset:gt,undent:$t};function dt(e){return ut[e]||void 0}function ft(e,t){let r=`<?> at line: ${F(t.input,t.pos)}
`;for(let s=0;s<t.tree.length;s+=1){const a=et(t.tree[s]);r+=`${a}
`}return r+=xt(t.input,t.pos),console.log(r),!0}function pt(e,t){const r=t.stack[t.depth],s=t.metadata_stack[t.depth];if(t.tree.length-r<3)return!0;let a=r-1,n=s-1;return t.tree[r]=o(0),t.tree.length=r+1,t.metadata_tree[s]=l(0),t.metadata_tree.length=s+1,!0;function o(u){a+=1;let i=t.tree[a];for(;;){a+=1;const c=t.tree[a];let d=c?0:-1;const f=c?c[0].slice(-3):void 0;if(f&&f[0]==="_"){const p=f.charCodeAt(1);f[2]==="L"&&(d=(p<<1)+1),f[2]==="R"&&(d=p+1<<1)}if(d<u){a-=1;break}d=d%2===0?d-1:d+1,i=[c[1],[i,o(d)]]}return i}function l(u){n+=1;let i=t.metadata_tree[n];for(;;){n+=1;const c=t.metadata_tree[n];let d=c?0:-1;const f=c?.[0]?.rule?c.rule.slice(-3):void 0;if(f&&f[0]==="_"){const m=f.charCodeAt(1);f[2]==="L"&&(d=(m<<1)+1),f[2]==="R"&&(d=m+1<<1)}if(d<u){n-=1;break}d=d%2===0?d-1:d+1,i={rule:c.rule,start:c.start,end:c.end,id:c.id,children:[i,l(d)]}}return i}}function j(e,t){const s=e[1].slice(1,-1).split(" ")[1],a=t.codex.names[s];if(!t.code[a])throw`${e[1]} undefined rule: ${s}`;let o="";for(let l=t.tree.length-1;l>=0;l-=1){const[u,i]=t.tree[l];if(u===s){o=i;break}}return o===""?!0:t.input.startsWith(o,t.pos)?(t.pos+=o.length,!0):!1}function ht(e,t){const r=t.input,s=t.start[t.depth],a=t.pos,n=r.slice(s,a),o=r.indexOf(n,a);if(o===-1)return!1;const l=r.slice(a,o);t.tree.push(["quote",l]);const u={rule:"quote",start:a,end:o,id:t.last_match_id++,match:l,children:[]};return t.metadata_tree.push(u),t.pos=o+n.length,t.peak<t.pos&&(t.peak=t.pos),!0}function _t(e,t){const r=t.input,s=t.start[t.depth],a=t.pos;let n="";for(let i=a-1;i>=s;i-=1)n+=r[i];const o=r.indexOf(n,a);if(o===-1)return!1;const l=r.slice(a,o);t.tree.push(["quoter",l]);const u={rule:"quoter",start:a,end:o,id:t.last_match_id++,match:l,children:[]};return t.metadata_tree.push(u),t.pos=o+n.length,t.peak<t.pos&&(t.peak=t.pos),!0}function mt(e,t){const r=t.input,s=t.pos;let a=s;for(;r[a]===" ";)a+=1;if(a===s)for(;r[a]==="	";)a+=1;if(a===s)return!1;const n=t.indent.at(-1);if(n&&a-s<=n.length)return!1;if(n&&n[0]!==r[s])throw"indent: mixed space & tab";return t.indent.push(t.input.slice(s,a)),!0}function gt(e,t){const r=t.input,s=t.pos;let a=s;for(;r[a]===" ";)a+=1;if(a===s)for(;r[a]==="	";)a+=1;return a===s?!1:r.slice(s,a)===t.indent.at(-1)}function $t(e,t){return t.indent.pop(),!0}function xt(e,t,r=""){let s=t;for(;s>0&&e[s-1]!==`
`&&e[s-1]!=="\r";)s-=1;let a=t;for(;a<e.length&&e[a]!==`
`&&e[a]!=="\r";)a+=1;const{row:n}=V(e,t);let o=Q(-1);for(let i=s;i<t;i+=1)o+=" ";const l=kt(e,n,s,a,3),u=wt(e,n,a,2);return`${l}${o}^${u}${r}`}function F(e,t){return V(e,t).at}function V(e,t){let r=0,s=0,a=1,n=1;for(;r<t;)for(e[r]==="\r"&&(a+=1,r+=1),e[r]===`
`&&(n+=1,r+=1),s=r;r<t&&e[r]!==`
`&&e[r]!=="\r";)r+=1;const o=n>=a?n:a,l=t-s+1,u=`${o}.${l}`;return{row:o,col:l,at:u}}function kt(e,t,r,s,a){let n="";for(;;){if(n=`${Q(t)}${e.slice(r,s)}
${n}`,a-=1,r===0||a===0)return n;for(t-=1,r>0&&e[r-1]===`
`&&(r-=1),r>0&&e[r-1]==="\r"&&(r-=1),s=r;r>0&&e[r-1]!==`
`&&e[r-1]!=="\r";)r-=1}}function wt(e,t,r,s){let a="";for(;s>0&&r<e.length;){t+=1;let n=r;e[n]===`
`&&(n+=1),n<e.length&&e[n]==="\r"&&(n+=1);let o=n;for(;o<e.length&&e[o]!==`
`&&e[o]!=="\r";)o+=1;a+=`
${Q(t)}${e.slice(n,o)}`,r=o,s-=1}return a}function Q(e){const t="         ";if(e<0)return t;let r=` ${e} | `;for(;r.length<t.length;)r=` ${r}`;return r}function qt(e,t){return t.trace||(t.trace=!0,t.trace_depth=t.depth,_(`        ${t.rule_names[t.trace_depth]}`)),!0}function bt(e,t){if(t.trace_depth===-1){if(t.trace!==e)return;t.trace_depth=t.depth}_($(t)+e)}function S(e,t,r,s){if(t.trace_depth!==-1&&!(t.depth+1<t.trace_depth))if(r===!1)_(`${$(t)}${g(e)} != ${v(t)}`);else if(r===!0)_(`${$(t)}${e[2]} == ${O(t,s,t.pos)}`);else{let a=JSON.stringify(r);a.length>70&&(a=`${a.slice(0,60)} ... ]`),_(`${$(t)}${e[2]} => ${a}`)}}function U(e,t){t.trace_depth!==-1&&_($(t)+g(e))}function K(e,t,r){t.trace_depth!==-1&&_(`${$(t)}${g(e)} == ${O(t,r,t.pos)}`)}function Y(e,t){t.trace_depth!==-1&&_(`${$(t)}${g(e)} != ${v(t)}`)}function Et(e,t,r){if(t.trace_depth===-1)return;const[s,a,n]=e;let o=r;a==="!"&&(o=!o);const l=o?" == ":" != ";_($(t)+g(n)+l)}function yt(e,t){t.trace_depth!==-1&&_($(t)+e[1])}function v(e){let t=e.pos;for(;e.input[t]>=" ";)t+=1;return t-e.pos>2?O(e,e.pos,t):O(e,e.pos,e.input.length)}function O(e,t,r){let s=e.input.slice(t,r);return s.length>40&&(s=`${s.slice(0,30)} ...`),T(s)}function $(e){let t=F(e.input,e.pos);for(;t.length<8;)t+=" ";for(let r=e.trace_depth;r<e.depth;r+=1)t+="|  ";return t}function g(e){if(typeof e=="string")return e;switch(e[0]){case L:return e[2];case M:return`'${T(e[2])}'`;case k:{const[t,r,s,a,n]=e;return`${r?"~":""}[${T(n)}]${A(s,a)}`}case B:{const[t,r,s]=e;return r+g(s)}case X:{const[t,r,s,a]=e;return`${g(a)}${A(r,s)}`}case H:return`(${e[1].map(g).join("/")})`;case E:{const[t,r,s,a]=e;return`(${a.map(g).join(" ")})${A(r,s)}`}case D:return e[1];default:return"(...)"}}function A(e,t){return e===0&&t===0?"*":e===0&&t===1?"?":e===1&&t===0?"+":e===1&&t===1?"":t===0?`*${e}..`:`*${e}..${t}`}function T(e){let t="";for(const r of e)if(r>=" ")t+=r;else if(r===`
`)t+="\\n";else if(r==="\r")t+="\\r";else if(r==="	")t+="\\t";else{let a=r.charCodeAt(0).toString(16);for(;a.length<4;)a=`0${a}`;t+=`\\u${a}`}return t}function tt(e){const t={};let r;for(let i=0;i<e.length;i+=1){const[c,[[d,f],p]]=e[i];i===0&&(r=f),t[f]=i}const s=[L,0,r],a=[];for(const i of e){const[c,[[d,f],p]]=i;a.push(n(p))}for(let i=0;i<a.length;i+=1)l(a[i],a);return{rules:e,names:t,code:a,start:s};function n(i){switch(i[0]){case"id":{const c=i[1],d=t[c];if(d===void 0)throw`Undefined rule: ${c}`;return[L,d,c]}case"alt":return[H,i[1].map(n)];case"seq":return[E,1,1,i[1].map(n)];case"rep":{const[c,[d,f]]=i[1],[p,m]=o(d,f),h=n(c);if(h[0]===E){const[q,b,x,R]=h;if(b===1&&x===1)return[E,p,m,R]}if(h[0]===k){const[q,b,x,R,ot]=h;if(x===1&&R===1)return[k,b,p,m,ot]}if(h[0]===M){const[q,b,x]=h;if(x.length===1)return[k,!1,p,m,x]}return[X,p,m,h]}case"pre":{const[[c,d],f]=i[1],p=n(f);if(d==="~"){if(p[0]===M){const[m,h,q]=p;if(!h)return[k,!0,1,1,q]}else if(p[0]===k){const[m,h,q,b,x]=p;if(!h)return[k,!0,q,b,x]}}return[B,d,p]}case"sq":{const c=i[1],d=c.slice(-1)==="i";let f=d?c.slice(1,-2):c.slice(1,-1);return f=z(f),d&&(f=f.toUpperCase()),[M,d,f]}case"chs":{let c=i[1].slice(1,-1);return c=z(c),[k,!1,1,1,c]}case"extn":return[D,i[1]];default:throw`Undefined ptree node: ${i}`}}function o(i,c){let d=0,f=0;if(i==="sfx")c==="+"?d=1:c==="?"&&(f=1);else if(i==="num")d=Number.parseInt(c,10),f=d;else if(i==="range")c.length===2?d=Number.parseInt(c[0][1],10):(d=Number.parseInt(c[0][1],10),f=Number.parseInt(c[2][1],10));else throw`unknown suffix: ${i}`;return[d,f]}function l(i,c){switch(i[0]){case E:{for(const d of i[3])l(d,c);return}case H:{const d=i[1],f=[];for(let p=0;p<d.length;p+=1)f.push(u(d[p],c));i.push(f);return}default:return}}function u(i,c){switch(i[0]){case L:return u(c[i[1]],c);case E:return u(i[3][0],c);case M:return i[2][0];default:return null}}}const Ct={t:"	",n:`
`,r:"\r"};function z(e){let t="";for(let r=0;r<e.length;r+=1){const s=e[r];if(s!=="\\"){t+=s;continue}const a=e[r+1],n=Ct[a];if(n){r+=1,t+=n;continue}if(a==="u"&&r+5<e.length){const o=e.slice(r+2,r+6);t+=String.fromCharCode(Number.parseInt(o,16)),r+=5;continue}if(a==="U"&&r+9<e.length){const o=e.slice(r+2,r+10);t+=String.fromCharCode(Number.parseInt(o,16)),r+=9;continue}t+="\\"}return t}function et(e,t=!1){return e?t?P(e):rt(e,0,0):""}function rt(e,t,r){const s=e[0];if(typeof e[1]=="string")return`${s} "${T(e[1])}"`;let a=`
`;for(let i=0;i<t;i+=1)a+=(r>>i&1)===1?"  ":"â”‚ ";const n=e[1];let o="",l="â”œâ”€",u=r;for(let i=0;i<n.length;i+=1)i===n.length-1&&(l="â””â”€",u|=1<<t),o+=a+l+rt(n[i],t+1,u);return s+o}function P(e,t=""){if(!e)return"";const r=e[0];if(typeof e[1]=="string")return`${t}["${r}", "${T(e[1])}"]`;const s=e[1];let a=`${t}["${r}", [
`;const n=`${t}  `,o=s.length-1;for(let u=0;u<o;u+=1){const i=P(s[u],n);a+=`${i},
`}const l=P(s[o],n);return a+=`${l}
${t}]]`,a}function _(e){console.log(e)}const St=(e,t)=>({codex:e,code:e.code,extend:{},options:{},input:t,pos:0,peak:0,depth:0,max_depth:100,rule_names:[],tree:[],metadata_tree:[],last_match_id:0,panic:"",trace:!1,trace_depth:-1,start:[],stack:[],metadata_stack:[],indent:[],result:!0});function J(e,t,r,s){const a=St(e,t);r&&(a.extend=r),s&&(a.options=s,s.trace&&(a.trace=s.trace));const n=e.start,o=n[0](n,a);let l;if(a.panic?l={type:"internal_panic",message:a.panic}:a.tree.length!==1?l={type:"internal_error",message:"Bad ptree"}:o?a.pos<t.length&&!a.options.short&&(l={type:"incomplete_parse",message:`Parsed only ${a.pos} of ${t.length} characters`,location:F(a.input,a.pos)}):l={type:"parse_failed",message:"Failed to parse input"},l){const u={rule:"root",start:a.peak,end:a.peak,id:a.last_match_id++,children:[],error:l};return a.metadata_tree[0]?a.metadata_tree[0].children.push(u):a.metadata_tree.push(u),a.result=o,{ok:!1,env:a,rules:a.codex.rules.map(([i,[c]])=>c),ptree_metadata:a.metadata_tree[0]}}return{ok:!0,rules:a.codex.rules.map(([u,[[i,c]]])=>c),ptree:a.tree[0],ptree_metadata:a.metadata_tree[0]}}function Mt(e,t,r){const s=J(lt,e,{},r);if(!s.ok)return s.ptree_metadata.error||(s.ptree_metadata.error={type:"grammar_error",message:s.env.panic}),{env:s.env,ok:!1,ptree_metadata:s.ptree_metadata};try{s.codex=tt(s.ptree[1])}catch(a){return s.ptree_metadata.error||(s.ptree_metadata.error={type:"uncaught_error",message:a}),{ok:!1,env:s.env,ptree_metadata:s.ptree_metadata}}return{ok:!0,parse:(a,n)=>J(s.codex,a,t,n)}}function Tt(e){const t=[];function r(s){s.error&&t.push(`${s.error.type}: ${s.error.message}`),s.children.map(r)}return r(e),t.length===0?"No errors.":`Encountered ${t.length} errors: ${t}`}const Nt={compile:Mt,show_tree:et,show_err:Tt},Lt=(e,t=300)=>{let r;return function(...s){r&&clearTimeout(r),r=setTimeout(()=>e.apply(this,s),t)}};function I(e,t="",r=!0,s=0){const a=s===0?"":t,n=s===0?"":r?"â””â”€":"â”œâ”€",o=r?"  ":"â”‚ ";let l="";e.error?l=`ðŸ›‘ ${e.error.type}: ${e.error.message}`:(l=e.rule,e.match&&(l+=` "${e.match}"`));const u=` data-rule="${e.rule}"${e.id?` data-matchid="${e.id}"`:""}`;let i=`${a}${n}<span class="node-label"${u}>${l}</span>
`;if(e.children&&e.children.length>0){const c=t+o;e.children.forEach((d,f)=>{const p=f===e.children.length-1;i+=I(d,c,p,s+1)})}return i}function Z(e){let t=null;function r(s){if(!t){if(s.error){t={error:s.error,end:s.end,start:s.start,node:s};return}s.children&&s.children.length>0&&s.children.forEach(a=>r(a))}}return r(e),t}const Ot=e=>{const t=window.getSelection();if(!t||t.rangeCount===0)return null;const r=t.getRangeAt(0);if(!e.contains(r.startContainer)||!e.contains(r.endContainer))return null;const s=r.cloneRange();s.selectNodeContents(e),s.setEnd(r.startContainer,r.startOffset);const a=s.toString().length,n=r.toString().length;return{start:a,end:a+n}},Rt=(e,t,r)=>{const s=document.createRange(),a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let n=0,o=null,l=null,u=0,i=0,c;for(;c=a.nextNode();){const f=c.nodeValue?.length??0;if(!o&&n+f>=t&&(o=c,u=t-n),n+f>=r){l=c,i=r-n;break}n+=f}o?(s.setStart(o,u),s.setEnd(l??o,l?i:u)):(s.setStart(e,e.childNodes.length),s.setEnd(e,e.childNodes.length));const d=window.getSelection();d&&(d.removeAllRanges(),d.addRange(s))},C=e=>{const t=document.querySelector(e);if(!t)throw new Error("No element found: "+e);return t},st=C("#examples"),y=C("#grammar"),w=C("#input"),N=C("#output"),at=C("#json"),nt=()=>{const e=st.value,t=C(`#option-${e}`);w.textContent=t.dataset.input??"",y.textContent=t.dataset.grammar??"",W()},it=Lt(()=>W(),300),W=()=>{const e=document.activeElement,t=e===w||e===y?e:null,r=t?Ot(t):null;jt(),t&&r&&(t.focus(),Rt(t,r.start,r.end))},jt=()=>{const e=Nt.compile(y.innerText);if(e.ok){const t=e.parse(w.innerText);console.log(t);const r=at.checked;if(r||(N.innerHTML=I(t.ptree_metadata)),t.ok)r&&(N.innerText=JSON.stringify(t.ptree,null,2)),w.innerHTML=w.innerText;else{r&&(N.innerText=t.show_err());const s=Z(t.ptree_metadata);w.innerHTML=G(w.innerText,s)}}else{N.innerHTML=I(e.ptree_metadata);const t=Z(e.ptree_metadata);y.innerHTML=G(y.innerText,t)}};function G(e,t){if(!t)return e;const r={start:Math.max(0,t.start),end:Math.max(0,t.end)};if(r.end<r.start)return e;let s="",a=!1;for(let n=0;n<e.length;n++)!a&&n===r.start&&(s+='<span class="input-error-highlight">',a=!0),s+=e[n],a&&n===r.end&&(s+="</span>",a=!1);return a&&r.start<e.length&&(s+='</span><span class="input-error-highlight input-error-placeholder" contenteditable="false"></span>',a=!1),r.start>=e.length&&(s+='<span class="input-error-highlight input-error-placeholder" contenteditable="false"></span>'),s}st.addEventListener("change",nt);at.addEventListener("change",W);w.addEventListener("input",it);y.addEventListener("input",it);nt();
