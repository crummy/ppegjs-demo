const at=[["rule",[["id","Peg"],["seq",[["id","_"],["rep",[["id","rule"],["sfx","+"]]],["id","_"]]]]],["rule",[["id","rule"],["seq",[["id","id"],["id","_"],["sq","'='"],["id","_"],["id","alt"]]]]],["rule",[["id","alt"],["seq",[["id","seq"],["rep",[["seq",[["sq","'/'"],["id","_"],["id","seq"]]],["sfx","*"]]]]]]],["rule",[["id","seq"],["rep",[["id","rep"],["sfx","+"]]]]],["rule",[["id","rep"],["seq",[["id","pre"],["rep",[["id","sfx"],["sfx","?"]]],["id","_"]]]]],["rule",[["id","pre"],["seq",[["rep",[["id","pfx"],["sfx","?"]]],["id","term"]]]]],["rule",[["id","term"],["alt",[["id","call"],["id","sq"],["id","chs"],["id","group"],["id","extn"]]]]],["rule",[["id","id"],["seq",[["chs","[a-zA-Z_]"],["rep",[["chs","[a-zA-Z0-9_]"],["sfx","*"]]]]]]],["rule",[["id","pfx"],["chs","[&!~]"]]],["rule",[["id","sfx"],["alt",[["chs","[+?]"],["seq",[["sq","'*'"],["rep",[["id","range"],["sfx","?"]]]]]]]]],["rule",[["id","range"],["seq",[["id","num"],["rep",[["seq",[["id","dots"],["rep",[["id","num"],["sfx","?"]]]]],["sfx","?"]]]]]]],["rule",[["id","num"],["rep",[["chs","[0-9]"],["sfx","+"]]]]],["rule",[["id","dots"],["sq","'..'"]]],["rule",[["id","call"],["seq",[["id","id"],["id","_"],["pre",[["pfx","!"],["sq","'='"]]]]]]],["rule",[["id","sq"],["seq",[["chs","[']"],["rep",[["pre",[["pfx","~"],["chs","[']"]]],["sfx","*"]]],["chs","[']"],["rep",[["sq","'i'"],["sfx","?"]]]]]]],["rule",[["id","chs"],["seq",[["sq","'['"],["rep",[["pre",[["pfx","~"],["sq","']'"]]],["sfx","*"]]],["sq","']'"]]]]],["rule",[["id","group"],["seq",[["sq","'('"],["id","_"],["id","alt"],["sq","')'"]]]]],["rule",[["id","extn"],["seq",[["sq","'<'"],["rep",[["pre",[["pfx","~"],["sq","'>'"]]],["sfx","*"]]],["sq","'>'"]]]]],["rule",[["id","_"],["rep",[["alt",[["seq",[["sq","'#'"],["rep",[["pre",[["pfx","~"],["chs",`[
\r]`]]],["sfx","*"]]]]],["rep",[["chs",`[ 	
\r]`],["sfx","*"]]]]],["sfx","*"]]]]]],ft=rt(at);function M(e,t){const[,n,s]=e,r=t.pos,o=t.depth,i=t.trace_history.length;t.trace_history.push(n,o,r,0);const a=t.code[n];if(t.panic||t.depth>t.max_depth)return t.panic||(t.panic=`max depth of recursion exceeded in rules:
 ... ${t.rule_names.slice(-6).join(" ")}
`),t.trace_history[i]=-(n+1),t.trace_history[i+3]=t.pos,!1;t.trace&&bt(s,t),t.depth+=1,t.rule_names[t.depth]=s,t.start[t.depth]=r;const u=a[0](a,t);return t.depth-=1,u===!1?(t.trace&&X(e,t,!1),t.pos>t.fault_pos&&(t.fault_pos=t.pos,t.fault_rule=s,t.fault_exp=e),t.trace_history[i]=-(n+1),t.trace_history[i+3]=t.pos,t.pos=r,!1):(t.trace_history[i+3]=t.pos,t.trace&&X(e,t,!0,r),!0)}function Q(e,t){t.trace&&W(e,t);const n=t.pos,s=t.input[n];let r=!1;for(let o=0;o<e[1].length;o+=1){if(!t.trace&&e.length>2){const u=e[2][o];if(u&&s!==u)continue}const i=e[1][o];if(i[0](i,t)){r=!0;break}t.pos=n}return r||t.pos>t.fault_pos&&(t.fault_pos=t.pos,t.fault_rule=t.rule_names[t.depth],t.fault_exp=e),r}function E(e,t){t.trace&&W(e,t);const[n,s,r,o]=e;let i=0;for(;;){let a=0,u=t.pos;for(a=0;a<o.length;a+=1){const c=o[a];if(c[0](c,t)===!1)return i>=s?(t.pos=u,!0):!1}if(i+=1,i===r||t.pos===u)break;u=t.pos}return i>=s}function B(e,t){t.trace&&W(e,t);const[n,s,r,o]=e;let i=0,a=t.pos;for(;!(o[0](o,t)===!1||(i+=1,a===t.pos)||i===r);)a=t.pos;return!(i<s)}function V(e,t){const[n,s,r]=e,o=t.pos,i=t.trace,a=t.peak;t.trace=!1;const u=r[0](r,t);return t.peak=a,t.trace=i,i&&St(e,t,u),t.pos=o,s==="~"?u===!0||t.pos>=t.input.length?!1:(t.pos=o+1,t.peak<t.pos&&(t.peak=t.pos),!0):s==="!"?!u:u}function N(e,t){const n=t.pos,s=t.input,[r,o,i]=e,a=i.length;if(a===0)return!0;let u=t.pos;for(let c=0;c<a;c+=1){let l=s[u];if(o&&u<s.length&&(l=l.toUpperCase()),i[c]!==l)return t.pos=n,t.pos>t.fault_pos&&(t.fault_pos=t.pos,t.fault_rule=t.rule_names[t.depth],t.fault_exp=e),t.trace&&tt(e,t),!1;u+=1}return t.pos=u,u>t.peak&&(t.peak=u),t.trace&&v(e,t,n),!0}function w(e,t){const n=t.input,s=t.pos,[r,o,i,a,u]=e;let c=t.pos,l=0;for(;c<n.length;){let f=!1;const p=t.input[c];for(let h=0;h<u.length;h+=1){if(h+2<u.length&&u[h+1]==="-"){if(p<u[h]||p>u[h+2]){h+=2;continue}}else if(p!==u[h])continue;f=!0;break}if(o&&(f=!f),!f||(l+=1,c+=1,l===a))break}return l<i?(t.pos>t.fault_pos&&(t.fault_pos=t.pos,t.fault_rule=t.rule_names[t.depth],t.fault_exp=e),t.trace&&tt(e,t),!1):(t.pos=c,c>t.peak&&(t.peak=c),t.trace&&v(e,t,s),!0)}function K(e,t){const s=e[1].slice(1,-1).split(" ")[0],r=t.extend[s]||ht(s);if(!r)return t.panic=`Missing extension function: ${s}`,!1;try{const o=r(e,t);return t.trace&&Et(e,t,o),!!o}catch(o){return t.panic=o,!1}}const pt={"?":dt,trace:qt,"@":L,eq:L,at:L,infix:gt,quote:_t,quoter:mt,indent:xt,inset:$t,undent:wt};function ht(e){return pt[e]||void 0}function dt(e,t){let n=`<?> at line: ${T(t.input,t.pos)}
`;const s=t.codex.rules.map(([r,[[o,i]]])=>i);for(let r=0;r<t.trace_history.length;r+=4){const o=t.trace_history[r],i=t.trace_history[r+1],a=t.trace_history[r+2],u=t.trace_history[r+3],c=o<0,l=c?-o-1:o,f=s[l]??"?",p=c?"!":" ";n+=`${"  ".repeat(i)}${p}${f} [${a}, ${u}]
`}return n+=Y(t.input,t.pos),console.log(n),!0}function gt(e,t){return!0}function L(e,t){const s=e[1].slice(1,-1).split(" ")[1],r=t.codex.names[s],o=t.code[r],{row:i,col:a}=y(t.input,t.pos);if(!o)throw`${e[1]} undefined rule: ${s} at line ${i}, column ${a}`;let u="";for(let c=t.trace_history.length-4;c>=0;c-=4){const l=t.trace_history[c];if(l<0||l!==r)continue;const f=t.trace_history[c+2],p=t.trace_history[c+3];u=t.input.slice(f,p);break}return u===""?!0:t.input.startsWith(u,t.pos)?(t.pos+=u.length,!0):!1}function _t(e,t){const n=t.input,s=t.start[t.depth],r=t.pos,o=n.slice(s,r),i=n.indexOf(o,r);return i===-1?!1:(t.pos=i+o.length,t.peak<t.pos&&(t.peak=t.pos),!0)}function mt(e,t){const n=t.input,s=t.start[t.depth],r=t.pos;let o="";for(let a=r-1;a>=s;a-=1)o+=n[a];const i=n.indexOf(o,r);return i===-1?!1:(t.pos=i+o.length,t.peak<t.pos&&(t.peak=t.pos),!0)}function xt(e,t){const n=t.input,s=t.pos;let r=s;for(;n[r]===" ";)r+=1;if(r===s)for(;n[r]==="	";)r+=1;if(r===s)return!1;const o=t.indent.at(-1);if(o&&r-s<=o.length)return!1;if(o&&o[0]!==n[s])throw"indent: mixed space & tab";return t.indent.push(t.input.slice(s,r)),!0}function $t(e,t){const n=t.input,s=t.pos;let r=s;for(;n[r]===" ";)r+=1;if(r===s)for(;n[r]==="	";)r+=1;return r===s?!1:n.slice(s,r)===t.indent.at(-1)}function wt(e,t){return t.indent.pop(),!0}function Y(e,t,n=""){let s=t;for(;s>0&&e[s-1]!==`
`&&e[s-1]!=="\r";)s-=1;let r=t;for(;r<e.length&&e[r]!==`
`&&e[r]!=="\r";)r+=1;const{row:o}=y(e,t);let i=D(-1);for(let c=s;c<t;c+=1)i+=" ";const a=yt(e,o,s,r,3),u=kt(e,o,r,2);return`${a}${i}^${u}${n}`}function T(e,t){return y(e,t).at}function y(e,t){let n=0,s=0,r=1,o=1;for(;n<t;)for(e[n]==="\r"&&(r+=1,n+=1),e[n]===`
`&&(o+=1,n+=1),s=n;n<t&&e[n]!==`
`&&e[n]!=="\r";)n+=1;const i=o>=r?o:r,a=t-s+1,u=`${i}.${a}`;return{row:i,col:a,at:u}}function yt(e,t,n,s,r){let o="";for(;;){if(o=`${D(t)}${e.slice(n,s)}
${o}`,r-=1,n===0||r===0)return o;for(t-=1,n>0&&e[n-1]===`
`&&(n-=1),n>0&&e[n-1]==="\r"&&(n-=1),s=n;n>0&&e[n-1]!==`
`&&e[n-1]!=="\r";)n-=1}}function kt(e,t,n,s){let r="";for(;s>0&&n<e.length;){t+=1;let o=n;e[o]===`
`&&(o+=1),o<e.length&&e[o]==="\r"&&(o+=1);let i=o;for(;i<e.length&&e[i]!==`
`&&e[i]!=="\r";)i+=1;r+=`
${D(t)}${e.slice(o,i)}`,n=i,s-=1}return r}function D(e){const t="         ";if(e<0)return t;let n=` ${e} | `;for(;n.length<t.length;)n=` ${n}`;return n}function qt(e,t){return t.trace||(t.trace=!0,t.trace_depth=t.depth,m(`        ${t.rule_names[t.trace_depth]}`)),!0}function bt(e,t){if(t.trace_depth===-1){if(t.trace!==e)return;t.trace_depth=t.depth}m(x(t)+e)}function X(e,t,n,s){if(t.trace_depth!==-1&&!(t.depth+1<t.trace_depth))if(n===!1)m(`${x(t)}${_(e)} != ${et(t)}`);else if(n===!0)m(`${x(t)}${e[2]} == ${I(t,s,t.pos)}`);else{let r=JSON.stringify(n);r.length>70&&(r=`${r.slice(0,60)} ... ]`),m(`${x(t)}${e[2]} => ${r}`)}}function W(e,t){t.trace_depth!==-1&&m(x(t)+_(e))}function v(e,t,n){t.trace_depth!==-1&&m(`${x(t)}${_(e)} == ${I(t,n,t.pos)}`)}function tt(e,t){t.trace_depth!==-1&&m(`${x(t)}${_(e)} != ${et(t)}`)}function St(e,t,n){if(t.trace_depth===-1)return;const[s,r,o]=e;let i=n;r==="!"&&(i=!i);const a=i?" == ":" != ";m(x(t)+_(o)+a)}function Et(e,t,n){t.trace_depth!==-1&&m(x(t)+e[1])}function et(e){let t=e.pos;for(;e.input[t]>=" ";)t+=1;return t-e.pos>2?I(e,e.pos,t):I(e,e.pos,e.input.length)}function I(e,t,n){let s=e.input.slice(t,n);return s.length>40&&(s=`${s.slice(0,30)} ...`),O(s)}function x(e){let t=T(e.input,e.pos);for(;t.length<8;)t+=" ";for(let n=e.trace_depth;n<e.depth;n+=1)t+="|  ";return t}function _(e){if(typeof e=="string")return e;switch(e[0]){case M:return e[2].toString();case N:return`'${O(e[2])}'`;case w:{const[t,n,s,r,o]=e;return`${n?"~":""}[${O(o)}]${A(s,r)}`}case V:{const[t,n,s]=e;return n+_(s)}case B:{const[t,n,s,r]=e;return`${_(r)}${A(n,s)}`}case Q:return`(${e[1].map(_).join("/")})`;case E:{const[t,n,s,r]=e;return`(${r.map(_).join(" ")})${A(n,s)}`}case K:return e[1];default:return"(...)"}}function A(e,t){return e===0&&t===0?"*":e===0&&t===1?"?":e===1&&t===0?"+":e===1&&t===1?"":t===0?`*${e}..`:`*${e}..${t}`}function O(e){let t="";for(const n of e)if(n>=" ")t+=n;else if(n===`
`)t+="\\n";else if(n==="\r")t+="\\r";else if(n==="	")t+="\\t";else{let r=n.charCodeAt(0).toString(16);for(;r.length<4;)r=`0${r}`;t+=`\\u${r}`}return t}function rt(e){const t={};let n;for(let c=0;c<e.length;c+=1){const[l,[[f,p],h]]=e[c];c===0&&(n=p),t[p]=c}const s=[M,0,n],r=[];for(const c of e){const[l,[[f,p],h]]=c;r.push(o(h))}for(let c=0;c<r.length;c+=1)a(r[c],r);return{rules:e,names:t,code:r,start:s};function o(c){switch(c[0]){case"id":{const l=c[1],f=t[l];if(f===void 0)throw`Undefined rule: ${l}`;return[M,f,l]}case"alt":return[Q,c[1].map(o)];case"seq":return[E,1,1,c[1].map(o)];case"rep":{const[l,[f,p]]=c[1],[h,d]=i(f,p),g=o(l);if(g[0]===E){const[b,S,$,H]=g;if(S===1&&$===1)return[E,h,d,H]}if(g[0]===w){const[b,S,$,H,ut]=g;if($===1&&H===1)return[w,S,h,d,ut]}if(g[0]===N){const[b,S,$]=g;if($.length===1)return[w,!1,h,d,$]}return[B,h,d,g]}case"pre":{const[[l,f],p]=c[1],h=o(p);if(f==="~"){if(h[0]===N){const[d,g,b]=h;if(!g)return[w,!0,1,1,b]}else if(h[0]===w){const[d,g,b,S,$]=h;if(!g)return[w,!0,b,S,$]}}return[V,f,h]}case"sq":{const l=c[1],f=l.slice(-1)==="i";let p=f?l.slice(1,-2):l.slice(1,-1);return p=z(p),f&&(p=p.toUpperCase()),[N,f,p]}case"chs":{let l=c[1].slice(1,-1);return l=z(l),[w,!1,1,1,l]}case"extn":return[K,c[1]];default:throw`Undefined ptree node: ${c}`}}function i(c,l){let f=0,p=0;if(c==="sfx")l==="+"?f=1:l==="?"&&(p=1);else if(c==="num")f=Number.parseInt(l,10),p=f;else if(c==="range")l.length===2?f=Number.parseInt(l[0][1],10):(f=Number.parseInt(l[0][1],10),p=Number.parseInt(l[2][1],10));else throw`unknown suffix: ${c}`;return[f,p]}function a(c,l){switch(c[0]){case E:{for(const f of c[3])a(f,l);return}case Q:{const f=c[1],p=[];for(let h=0;h<f.length;h+=1)p.push(u(f[h],l));c.push(p);return}default:return}}function u(c,l){switch(c[0]){case M:return u(l[c[1]],l);case E:return u(c[3][0],l);case N:return c[2][0];default:return null}}}const Ct={t:"	",n:`
`,r:"\r"};function z(e){let t="";for(let n=0;n<e.length;n+=1){const s=e[n];if(s!=="\\"){t+=s;continue}const r=e[n+1],o=Ct[r];if(o){n+=1,t+=o;continue}if(r==="u"&&n+5<e.length){const i=e.slice(n+2,n+6);t+=String.fromCharCode(Number.parseInt(i,16)),n+=5;continue}if(r==="U"&&n+9<e.length){const i=e.slice(n+2,n+10);t+=String.fromCharCode(Number.parseInt(i,16)),n+=9;continue}t+="\\"}return t}function Nt(e,t=!1){return e?t?U(e):nt(e,0,0):""}function nt(e,t,n){const s=e[0];if(typeof e[1]=="string")return`${s} "${O(e[1])}"`;let r=`
`;for(let c=0;c<t;c+=1)r+=(n>>c&1)===1?"  ":"│ ";const o=e[1];let i="",a="├─",u=n;for(let c=0;c<o.length;c+=1)c===o.length-1&&(a="└─",u|=1<<t),i+=r+a+nt(o[c],t+1,u);return s+i}function U(e,t=""){if(!e)return"";const n=e[0];if(typeof e[1]=="string")return`${t}["${n}", "${O(e[1])}"]`;const s=e[1];let r=`${t}["${n}", [
`;const o=`${t}  `,i=s.length-1;for(let u=0;u<i;u+=1){const c=U(s[u],o);r+=`${c},
`}const a=U(s[i],o);return r+=`${a}
${t}]]`,r}function Tt(e,t,n){let s=null;const r=[];let o=null;for(let i=0;i<e.length;i+=4){const a=e[i],u=e[i+1],c=e[i+2],l=e[i+3];if(o!==null){if(u>o)continue;o=null}const f=a<0,p=f?-a-1:a,h=t[p];if(f||h&&h[0]==="_"){o=u;continue}const d={name:h,depth:u,start:c,end:l,children:[]};for(;r.length>0&&u<=r[r.length-1].depth;)r.pop();r.length>0?r[r.length-1].children.push(d):s=d,r.push(d)}return s?st(s,n):null}function st(e,t){const n=e.children.map(r=>st(r,t)).filter(Boolean),s=e.name;return n.length===0?[s,t.slice(e.start,e.end)]:n.length===1&&s[0]>"Z"?n[0]:[s,n]}function m(e){console.log(e)}const Ot=(e,t)=>({codex:e,code:e.code,extend:{},options:{},input:t,pos:0,peak:0,depth:0,max_depth:100,rule_names:[],trace_history:[],panic:"",fault_pos:-1,fault_rule:null,fault_exp:null,trace:!1,trace_depth:-1,start:[],indent:[],result:!0});function F(e,t,n={},s={}){const r=Ot(e,t);r.extend=n,r.options=s,s.trace&&(r.trace=s.trace);const o=e.start,i=o[0](o,r),a=r.codex.rules.map(([l,[[f,p]]])=>p),u=i?Tt(r.trace_history,a,r.input):null;let c;if(r.panic){const{row:l,col:f}=y(r.input,r.pos);c={type:"internal_panic",message:r.panic,line:l,column:f,input_snippet:r.input.slice(Math.max(0,r.pos-5),r.pos+10)}}else if(i){if(r.pos<t.length&&!r.options.short){const{row:l,col:f}=y(r.input,r.pos);c={type:"incomplete_parse",message:`Parsed only ${r.pos} of ${t.length} characters`,location:T(r.input,r.pos),line:l,column:f,input_snippet:r.input.slice(Math.max(0,r.pos-5),r.pos+10)}}else if(!u){const{row:l,col:f}=y(r.input,r.pos);c={type:"internal_error",message:"Empty parse tree",line:l,column:f,input_snippet:r.input.slice(Math.max(0,r.pos-5),r.pos+10)}}}else if(r.fault_pos>-1&&r.fault_rule&&r.fault_exp){const{row:l,col:f}=y(r.input,r.fault_pos);let p;try{p=_(r.fault_exp)}catch{p=r.fault_rule}c={type:"parse_failed",message:`Failed in rule: ${r.fault_rule}, expected: ${p}, at line: ${T(r.input,r.fault_pos)}`,line:l,column:f,fault_rule:r.fault_rule,input_snippet:Y(r.input,r.fault_pos),expected:p,found:r.input.slice(r.fault_pos,r.fault_pos+10),location:T(r.input,r.fault_pos)}}else{const{row:l,col:f}=y(r.input,r.pos);c={type:"parse_failed",message:"Failed to parse input",line:l,column:f,input_snippet:r.input.slice(Math.max(0,r.pos-5),r.pos+10)}}return c?(r.result=i,{ok:!1,env:r,rules:a,trace_history:r.trace_history,error:c}):{ok:!0,rules:a,ptree:u}}function Rt(e,t={},n={}){const s=F(ft,e,{},n);if(!s.ok)return{rules:s.rules,env:s.env,ok:!1,trace_history:s.trace_history,error:s.error};try{s.codex=rt(s.ptree[1],e)}catch(r){const o=typeof r=="object"&&r!==null&&"type"in r?r:{type:"uncaught_error",message:String(r)};return{ok:!1,env:s.env,trace_history:s.trace_history??[],error:o}}return{ok:!0,parse:(r,o)=>F(s.codex,r,t,o)}}function Mt(e){if(!e)return"No errors.";const t=e.error?e.error:e;return typeof t=="string"?t:t&&typeof t=="object"&&"type"in t&&"message"in t?`${t.type}: ${t.message}`:"No errors."}const It={compile:Rt,show_tree:Nt,show_err:Mt};function ot(e,t=0){const n="│ ".repeat(t),[s,r]=e;if(typeof r=="string")return`${n}${s} "${r}"`;let o=`${n}${s}`;for(const i of r)o+=`
`+ot(i,t+1);return o}function J(e,t,n){let s="";const r=[];for(let o=0;o<n.length;o+=4){const i=n[o],a=n[o+1],u=n[o+2],c=n[o+3],l="│ ".repeat(a),f=e.substring(u,c).replace(/\r?\n/g,"\\n").replace(/\t/g,"\\t"),p=i<0?t[-i-1]:t[i],h=`${l}${p} "${f}"`,d=s.length;s+=h,i<0&&h.length>0&&r.push({start:d,end:d+h.length-1}),s+=`
`}return{text:s,highlights:r}}function Z(e){let t=e.length-4,n=null,s=0;for(;t>=0;){if(e[t]<0){let r=e[t+1],o=e[t+2],i=e[t+3]+1;r>=s&&(n={start:o,end:i},s=r)}t-=4}return n}function P(e,t){const n=e.innerText,s=`${e.id||"input"}-error`,r=CSS.highlights,o=globalThis.Highlight;if(e.textContent=n,!r||!o||(r.delete(s),!t))return;const i={start:Math.max(0,t.start),end:Math.max(0,t.end)};if(i.end<i.start)return;const a=e.firstChild;if(!a||a.nodeType!==Node.TEXT_NODE)return;const u=Math.min(i.start,n.length),c=Math.min(i.end+1,n.length);if(u<n.length&&c>u){const l=document.createRange();l.setStart(a,u),l.setEnd(a,c),r.set(s,new o(l))}}function G(e,t,n){const s=e.innerText,r=CSS.highlights,o=globalThis.Highlight;if(e.textContent=s,!r||!o||(r.delete(n),!t.length))return;const i=e.firstChild;if(!i||i.nodeType!==Node.TEXT_NODE)return;const a=[];for(const u of t){const c=Math.min(Math.max(0,u.start),s.length),l=Math.min(Math.max(0,u.end+1),s.length);if(l<=c)continue;const f=document.createRange();f.setStart(i,c),f.setEnd(i,l),a.push(f)}a.length&&r.set(n,new o(...a))}const jt=e=>{const t=window.getSelection();if(!t||t.rangeCount===0)return null;const n=t.getRangeAt(0);if(!e.contains(n.startContainer)||!e.contains(n.endContainer))return null;const s=n.cloneRange();s.selectNodeContents(e),s.setEnd(n.startContainer,n.startOffset);const r=s.toString().length,o=n.toString().length;return{start:r,end:r+o}},Ht=(e,t,n)=>{const s=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let o=0,i=null,a=null,u=0,c=0,l;for(;l=r.nextNode();){const p=l.nodeValue?.length??0;if(!i&&o+p>=t&&(i=l,u=t-o),o+p>=n){a=l,c=n-o;break}o+=p}i?(s.setStart(i,u),s.setEnd(a??i,a?c:u)):(s.setStart(e,e.childNodes.length),s.setEnd(e,e.childNodes.length));const f=window.getSelection();f&&(f.removeAllRanges(),f.addRange(s))},C=e=>{const t=document.querySelector(e);if(!t)throw new Error("No element found: "+e);return t},it=C("#examples"),R=C("#grammar"),k=C("#input"),q=C("#output"),ct=C("#json"),lt=()=>{const e=it.value,t=C(`#option-${e}`);k.textContent=t.dataset.input??"",R.textContent=t.dataset.grammar??"",j()},j=()=>{const e=document.activeElement,t=e===k||e===R?e:null,n=t?jt(t):null;Lt(),t&&n&&(t.focus(),Ht(t,n.start,n.end))},Lt=()=>{const e=It.compile(R.innerText);if(e.ok){const t=e.parse(k.innerText);console.log(t);const n=ct.checked;if(t.ok)n?q.innerText=JSON.stringify(t.ptree,null,2):q.innerHTML=ot(t.ptree),P(k,null);else{if(n)q.innerText=t.show_err();else{const r=J(k.innerText,t.rules,t.trace_history);q.textContent=r.text,G(q,r.highlights,"output-error")}const s=Z(t.trace_history);P(k,s)}}else{const t=J(k.innerText,e.rules,e.trace_history);q.textContent=t.text,G(q,t.highlights,"output-error");const n=Z(e.trace_history);P(R,n)}};it.addEventListener("change",lt);ct.addEventListener("change",j);k.addEventListener("input",j);R.addEventListener("input",j);lt();
